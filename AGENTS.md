# AI Agent Integration Guide

This document describes how AI coding agents can use `pw-cli` for browser automation tasks.

## Quick Start

```bash
# Start the daemon for persistent sessions (recommended)
pw daemon start

# Navigate and extract content
pw navigate https://example.com
pw text -s "h1"                    # get heading text
pw html -s "main"                  # get HTML content
pw screenshot -o page.png          # capture screenshot

# When done
pw daemon stop
```

## Why Use the Daemon?

Without the daemon, each `pw` command spawns a new Playwright driver (~200ms) and launches a new browser (~300ms). With the daemon running, commands connect via Unix socket (~5ms) and reuse the existing browser instance.

## Common Patterns

### Extract page content

```bash
pw text https://example.com -s "article"           # text content
pw html https://example.com -s "article"           # HTML content
pw eval https://example.com "document.title"       # run JavaScript
```

### Extract readable content (articles, docs)

Use `pw read` to extract the main content from a page, automatically removing ads, navigation, sidebars, and other clutter:

```bash
pw read https://example.com                        # markdown (default)
pw read https://example.com -o text                # plain text
pw read https://example.com -o html                # cleaned HTML
pw read https://example.com -m                     # include metadata
pw read https://example.com -f text                # output content directly (not JSON)
```

This is ideal for reading articles, documentation, or any page where you want the content without the noise.

### Navigate and interact

```bash
pw navigate https://example.com
pw click -s "button.accept"        # click element (uses cached URL)
pw text -s ".result"               # read result
```

### Screenshots for visual verification

```bash
pw screenshot https://example.com -o before.png
pw click -s "button.toggle"
pw screenshot -o after.png
```

### Wait for dynamic content

```bash
pw navigate https://spa-app.com
pw wait -s ".loaded-content"       # wait for selector
pw text -s ".loaded-content"
```

### Authenticated sessions

```bash
# One-time: open browser and log in manually
pw auth login https://app.example.com -o auth.json

# Subsequent commands use saved session
pw --auth auth.json navigate https://app.example.com/dashboard
pw --auth auth.json text -s ".user-name"
```

### Connect to existing browser

Use `pw connect` to control a browser you've already opened (with your logged-in sessions, extensions, etc.):

```bash
# Launch Chrome with remote debugging enabled
google-chrome-stable --remote-debugging-port=9222

# Get the WebSocket URL
curl -s http://127.0.0.1:9222/json/version | jq -r .webSocketDebuggerUrl

# Set it once (stored in context)
pw connect "ws://127.0.0.1:9222/devtools/browser/..."

# All commands now use your existing browser
pw text https://example.com -s "h1"
pw screenshot -o page.png

# Clear when done
pw connect --clear
```

This is useful when you need access to existing login sessions or browser state that can't be captured with `pw auth`.

### Protect tabs from CLI access

When connecting to an existing browser, you may have tabs open (like Discord, Slack, or other PWAs) that you don't want the CLI to accidentally navigate or close. Use `pw protect` to mark URL patterns as protected:

```bash
# Add patterns to protect (substring match, case-insensitive)
pw protect add discord.com
pw protect add slack.com
pw protect add notion.so

# List protected patterns
pw protect list

# Remove a pattern
pw protect remove slack.com
```

Protected tabs:

- Are marked with `"protected": true` in `pw tabs list` output
- Cannot be switched to or closed via `pw tabs switch/close`
- Are skipped when the CLI selects which existing tab to reuse
- Can still be seen in `pw tabs list` (for awareness)

This prevents agents from accidentally navigating away from your important apps.

## Output Format

All commands output TOON (Token-Oriented Object Notation) by default, a compact format optimized for LLM token efficiency:

```
command: text
data:
  matchCount: 1
  selector: h1
  text: Example Domain
inputs:
  selector: h1
  url: "https://example.com"
ok: true
```

Use `-f json` for traditional JSON output. Errors include structured error info:

```
ok: false
command: text
error:
  code: ELEMENT_NOT_FOUND
  message: "No elements match selector: .missing"
```

## Context Caching

The CLI caches `last_url`, `last_selector`, and `last_output` between invocations. This enables conversational workflows:

```bash
pw navigate https://example.com    # caches URL
pw text -s h1                      # uses cached URL, caches selector
pw text                            # uses cached URL and selector
pw screenshot -o page.png          # uses cached URL
```

Disable caching with `--no-context` for isolated commands.

## Daemon Management

```bash
pw daemon start              # start background daemon
pw daemon start --foreground # run in foreground (for debugging)
pw daemon status             # show running browsers
pw daemon stop               # graceful shutdown
```

The daemon spawns browsers on ports 9222-10221. Currently only Chromium is supported for daemon-managed browsers.

## Flags Reference

| Flag               | Description                         |
| ------------------ | ----------------------------------- |
| `--no-daemon`      | Don't use daemon even if running    |
| `--no-context`     | Don't read/write context cache      |
| `--auth <file>`    | Use saved authentication state      |
| `--headful`        | Run browser with visible window     |
| `--browser <kind>` | chromium (default), firefox, webkit |
| `-v` / `-vv`       | Verbose / debug output              |

## Best Practices for Agents

1. **Start daemon at session begin**: Run `pw daemon start` once, then make many commands
1. **Use context caching**: Let URLs and selectors carry over between related commands
1. **Parse JSON output**: All commands return structured JSON for reliable parsing
1. **Handle errors gracefully**: Check `ok` field before accessing `data`
1. **Stop daemon when done**: Run `pw daemon stop` to clean up browser processes

# DEV NOTES

- Use `nix develop -c ...` to run cargo and other commands that require nix packages.
